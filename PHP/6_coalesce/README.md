[//]: # (This file is automatically generated. If you wish to make any changes, please use the JSON files and regenerate this file using the tpframework.)

# Coalesce

Tags: sast, php, php_v7.4.9

Version: v1.0

## Description

The coalescence operator (also known as the null coalescing operator) in PHP is used to check if a variable is set and not null, and if it is not, it returns a default value.

## Overview

| Instances                 | has discovery rule   | discovery method   | rule successfull   |
|---------------------------|----------------------|--------------------|--------------------|
| [1 Instance](#1-instance) | yes                  | joern              | yes                |
| [2 Instance](#2-instance) | yes                  | joern              | yes                |
| [3 Instance](#3-instance) | yes                  | joern              | yes                |

<details markdown="1"open>
<summary>

## 1 Instance
</summary>

This instance targets the use of the coalescing operator when we try to access an array element, that does not exist.

### Code

```PHP
<?php
$a = $_GET["p1"]; // source
$arr = array(1,2,3);
$b = $arr[4] ?? $a; //tarpit: $b assigned to $a as the 1st param of coalescing is null
echo $b; // sink
```

### Instance Properties

| category   | feature_vs_internal_api   | input_sanitizer   | negative_test_case   | source_and_sink   |
|------------|---------------------------|-------------------|----------------------|-------------------|
| S0         | FEATURE                   | no                | no                   | no                |

<details markdown="1">
<summary>
<b>More</b></summary>

<details markdown="1">
<summary>

### Compile
</summary>

```bash
$_main:
     ; (lines=10, args=0, vars=3, tmps=7)
     ; (before optimizer)
     ; /.../PHP/6_coalesce/1_instance_6_coalesce/1_instance_6_coalesce.php:1-5
     ; return  [] RANGE[0..0]
0000 T3 = FETCH_R (global) string("_GET")
0001 T4 = FETCH_DIM_R T3 string("p1")
0002 ASSIGN CV0($a) T4
0003 ASSIGN CV1($arr) array(...)
0004 T7 = FETCH_DIM_IS CV1($arr) int(4)
0005 T8 = COALESCE T7 0007
0006 T8 = QM_ASSIGN CV0($a)
0007 ASSIGN CV2($b) T8
0008 ECHO CV2($b)
0009 RETURN int(1)
```

</details>

<details markdown="1">
<summary>

### Discovery
</summary>

This rule should discover all usages of the null coalescing operator

```scala
val x6 = (name, "6_coalesce_iall", cpg.call(".*COALESCE.*").location.toJson);
```

| discovery method   | expected accuracy   |
|--------------------|---------------------|
| joern              | Perfect             |

</details>

<details markdown="1"open>
<summary>

### Measurement
</summary>

| Tool        | Comm_1   | Comm_2   | phpSAFE   | Progpilot   | RIPS   | WAP   | Ground Truth   |
|-------------|----------|----------|-----------|-------------|--------|-------|----------------|
| 08 Jun 2021 | yes      | yes      | yes       | no          | yes    | no    | yes            |
| 17 May 2023 | yes      | yes      |           |             |        |       | yes            |

</details>

<details markdown="1">
<summary>

### Remediation
</summary>

One could transform that case by inserting an if-statement, that checks for the length of the array before accessing certain indices. That might not work in all the cases though.

</details>

</details>

</details>

<details markdown="1">
<summary>

## 2 Instance
</summary>

This instance should show, that `null` triggers the alternative value to be inserted.

### Code

```PHP
<?php
$a = $_GET["p1"]; // source
$b = null ?? $a; //tarpit: $b assigned to $a as the 1st param of coalescing is null
echo $b; // sink
```

### Instance Properties

| category   | feature_vs_internal_api   | input_sanitizer   | negative_test_case   | source_and_sink   |
|------------|---------------------------|-------------------|----------------------|-------------------|
| S0         | FEATURE                   | no                | no                   | no                |

<details markdown="1">
<summary>
<b>More</b></summary>

<details markdown="1">
<summary>

### Compile
</summary>

```bash
$_main:
     ; (lines=8, args=0, vars=2, tmps=5)
     ; (before optimizer)
     ; /.../PHP/6_coalesce/2_instance_6_coalesce/2_instance_6_coalesce.php:1-4
     ; return  [] RANGE[0..0]
0000 T2 = FETCH_R (global) string("_GET")
0001 T3 = FETCH_DIM_R T2 string("p1")
0002 ASSIGN CV0($a) T3
0003 T5 = COALESCE null 0005
0004 T5 = QM_ASSIGN CV0($a)
0005 ASSIGN CV1($b) T5
0006 ECHO CV1($b)
0007 RETURN int(1)
```

</details>

<details markdown="1">
<summary>

### Discovery
</summary>

This rule should discover all usages of the null coalescing operator

```scala
val x6 = (name, "6_coalesce_iall", cpg.call(".*COALESCE.*").location.toJson);
```

| discovery method   | expected accuracy   |
|--------------------|---------------------|
| joern              | Perfect             |

</details>

<details markdown="1"open>
<summary>

### Measurement
</summary>

| Tool        | Comm_1   | Comm_2   | Ground Truth   |
|-------------|----------|----------|----------------|
| 17 May 2023 | yes      | yes      | yes            |

</details>

<details markdown="1">
<summary>

### Remediation
</summary>

One could rewrite this with an if-else statement, and check if something is `null` before assigning.

</details>

</details>

</details>

<details markdown="1">
<summary>

## 3 Instance
</summary>

This instance should show, that the coalescing operator works with a short version as well.

### Code

```PHP
<?php
$a = $_GET["p1"]; // source
$b = null;
$b ??= $a; //tarpit: $b assigned to $a as the 1st param of coalescing is null
echo $b; // sink
```

### Instance Properties

| category   | feature_vs_internal_api   | input_sanitizer   | negative_test_case   | source_and_sink   |
|------------|---------------------------|-------------------|----------------------|-------------------|
| S0         | FEATURE                   | no                | no                   | no                |

<details markdown="1">
<summary>
<b>More</b></summary>

<details markdown="1">
<summary>

### Compile
</summary>

```bash
$_main:
     ; (lines=10, args=0, vars=2, tmps=6)
     ; (before optimizer)
     ; /.../PHP/6_coalesce/3_instance_6_coalesce/3_instance_6_coalesce.php:1-5
     ; return  [] RANGE[0..0]
0000 T2 = FETCH_R (global) string("_GET")
0001 T3 = FETCH_DIM_R T2 string("p1")
0002 ASSIGN CV0($a) T3
0003 ASSIGN CV1($b) null
0004 T6 = COALESCE CV1($b) 0007
0005 T7 = ASSIGN CV1($b) CV0($a)
0006 T6 = QM_ASSIGN T7
0007 FREE T6
0008 ECHO CV1($b)
0009 RETURN int(1)
```

</details>

<details markdown="1">
<summary>

### Discovery
</summary>

This rule should discover all usages of the null coalescing operator

```scala
val x6 = (name, "6_coalesce_iall", cpg.call(".*COALESCE.*").location.toJson);
```

| discovery method   | expected accuracy   |
|--------------------|---------------------|
| joern              | Perfect             |

</details>

<details markdown="1"open>
<summary>

### Measurement
</summary>

| Tool        | Comm_1   | Ground Truth   |
|-------------|----------|----------------|
| 17 May 2023 | no       | yes            |

</details>

<details markdown="1">
<summary>

### Remediation
</summary>

This could be transformed in an if-statement.

</details>

</details>

</details>
